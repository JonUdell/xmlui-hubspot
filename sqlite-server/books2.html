<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMLUI-Inspired Web Components</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f9f9f9;
        }

        h1 {
            text-align: center;
        }

        h-stack {
            display: flex;
            gap: 10px;
        }

        cv-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        list-view {
            display: block;
            width: 30%;
        }

        list-card {
            display: block;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        list-card h3 {
            margin: 0 0 5px;
        }

        list-card p {
            margin: 0;
            color: #555;
        }
    </style>
</head>

<body>
    <app-layout layout="vertical">
        <h1>Testing SQLite Integration</h1>

        <h-stack>
            <cv-stack>
                <text-box id="newTitle" placeholder="Enter a book title" width="80%"></text-box>
                <text-box id="newAuthor" placeholder="Enter the author" width="80%"></text-box>
                <app-button label="Add book" id="addButton"></app-button>
            </cv-stack>

            <data-source id="books" url="http://hn.jonudell.info:8080/query" query="SELECT * FROM books"></data-source>

            <list-view data-source="books">
                <list-card title-field="title" subtitle-field="author"></list-card>
            </list-view>
        </h-stack>
    </app-layout>

    <script>
        // AppLayout
        customElements.define('app-layout', class extends HTMLElement {
            connectedCallback() {
                const layout = this.getAttribute('layout') || 'vertical';
                this.style.display = layout === 'vertical' ? 'block' : 'flex';
            }
        });

        // HStack and CVStack
        customElements.define('h-stack', class extends HTMLElement {
            connectedCallback() {
                this.style.display = 'flex';
                this.style.gap = '10px';
            }
        });

        customElements.define('cv-stack', class extends HTMLElement {
            connectedCallback() {
                this.style.display = 'flex';
                this.style.flexDirection = 'column';
                this.style.gap = '10px';
            }
        });

        // TextBox
        customElements.define('text-box', class extends HTMLElement {
            connectedCallback() {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = this.getAttribute('placeholder') || '';
                input.style.width = this.getAttribute('width') || '100%';
                this.appendChild(input);
            }

            get value() {
                return this.querySelector('input').value;
            }
        });

        // AppButton
        customElements.define('app-button', class extends HTMLElement {
            connectedCallback() {
                const button = document.createElement('button');
                button.textContent = this.getAttribute('label') || 'Click';
                button.addEventListener('click', () => this.dispatchEvent(new Event('click')));
                this.appendChild(button);
            }
        });

        // DataSource
        customElements.define('data-source', class extends HTMLElement {
            async connectedCallback() {
                console.log('DataSource connected, URL:', this.getAttribute('url'), 'Query:', this.getAttribute('query'));
                const url = this.getAttribute('url');
                const query = this.getAttribute('query');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql: query })
                });
                console.log('Data fetched:', await response.clone().json());
                this.data = await response.json();
                this.dispatchEvent(new Event('data-loaded'));
            }

            get data() {
                return this._data || [];
            }

            set data(value) {
                this._data = value;
            }
        });

        // ListView and ListCard
        customElements.define('list-view', class extends HTMLElement {
            connectedCallback() {
                const sourceId = this.getAttribute('data-source');
                const dataSource = document.getElementById(sourceId);

                dataSource.addEventListener('data-loaded', () => {
                    this.render(dataSource.data);
                });
            }

            render(data) {
                console.log('Rendering data:', data); // Debugging log
                this.innerHTML = '';
                data.forEach(item => {
                    const card = document.createElement('list-card');

                    // Set attributes dynamically
                    card.setAttribute('title-field', 'title');
                    card.setAttribute('subtitle-field', 'author');

                    card.data = item;
                    this.appendChild(card);
                });
            }
        });

        customElements.define('list-card', class extends HTMLElement {
            set data(item) {
                const titleField = this.getAttribute('title-field');
                const subtitleField = this.getAttribute('subtitle-field');

                // Debugging logs
                console.log('list-card title-field:', titleField);
                console.log('list-card subtitle-field:', subtitleField);
                console.log('list-card item data:', item);

                const title = item[titleField]; // Get the title from the item object
                const subtitle = item[subtitleField]; // Get the subtitle from the item object

                this.innerHTML = `
      <div style="border: 1px solid #ccc; padding: 10px; margin: 5px;">
        <h3>${title || 'No Title'}</h3>
        <p>${subtitle || 'No Subtitle'}</p>
      </div>
    `;
            }
        });

        // Event Handlers
        document.getElementById('addButton').addEventListener('click', async () => {
            const title = document.getElementById('newTitle').value;
            const author = document.getElementById('newAuthor').value;
            console.log('Adding book with Title:', title, 'Author:', author);

            if (!title || !author) {
                alert('Please enter both a title and an author.');
                return;
            }

            try {
                const response = await fetch('http://hn.jonudell.info:8080/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sql: `INSERT INTO books (title, author) VALUES (?, ?)`,
                        params: [title, author]
                    })
                });

                if (!response.ok) throw new Error('Failed to add book');
                document.getElementById('newTitle').value = '';
                document.getElementById('newAuthor').value = '';

                const booksSource = document.getElementById('books');
                booksSource.connectedCallback(); // Refresh data
            } catch (error) {
                console.error('Error adding book:', error);
                alert('Could not add book. Please try again.');
            }
        });
    </script>
</body>

</html>